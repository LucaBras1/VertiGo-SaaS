// TeamForge - Team Building Vertical
// Extends the shared core schema with team building-specific fields

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// TEAMFORGE ENUMS
// ========================================

enum ObjectiveType {
  COMMUNICATION // Improve communication
  TRUST // Build trust
  LEADERSHIP // Develop leadership
  PROBLEM_SOLVING // Problem-solving skills
  CREATIVITY // Creative thinking
  COLLABORATION // Team collaboration
  CONFLICT // Conflict resolution
  MOTIVATION // Team motivation
}

enum PhysicalLevel {
  LOW // Sedentary activities
  MEDIUM // Light physical activity
  HIGH // Intensive physical activity
}

enum IndoorOutdoor {
  INDOOR
  OUTDOOR
  BOTH
  FLEXIBLE
}

enum IndustryType {
  TECHNOLOGY
  FINANCE
  HEALTHCARE
  EDUCATION
  MANUFACTURING
  RETAIL
  HOSPITALITY
  CONSULTING
  GOVERNMENT
  NONPROFIT
  OTHER
}

// ========================================
// TEAMFORGE MODELS (Entity Mapping)
// ========================================

// Performance → Program (Complete team building program)
model Program {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info (from Performance)
  title    String
  slug     String  @unique
  category String  @default("team-building")
  status   String  @default("active")
  featured Boolean @default(false)
  order    Int     @default(100)

  // Content
  subtitle    String?
  excerpt     String?
  description Json?

  // TeamForge-Specific Fields
  teamSize             Int? // Ideal team size
  minTeamSize          Int? // Minimum participants
  maxTeamSize          Int? // Maximum participants
  objectives           Json? // Array of ObjectiveType
  industryType         String? // IndustryType
  physicalLevel        String? // PhysicalLevel
  indoorOutdoor        String? // IndoorOutdoor
  duration             Int // Duration in minutes
  includesCatering     Boolean @default(false)
  debriefIncluded      Boolean @default(true)
  facilitationRequired Boolean @default(true)

  // Technical Requirements
  technicalRequirements Json?
  materialsIncluded     Json? // Materials provided
  venueRequirements     Json? // Venue specifications

  // Pricing
  price          Int? // Base price
  pricePerPerson Int? // Price per participant
  pricingNotes   String?

  // Media
  featuredImageUrl String?
  featuredImageAlt String?
  galleryImages    Json?
  videoUrl         String?

  // SEO
  seo Json?

  // Relations
  sessions      Session[]
  activityLinks ProgramActivity[]
  orderItems    OrderItem[]

  @@index([status])
  @@index([slug])
  @@map("programs")
}

// Game → Activity (Individual team building activity)
model Activity {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info
  title    String
  slug     String  @unique
  category String  @default("team-activity")
  status   String  @default("active")
  featured Boolean @default(false)
  order    Int     @default(100)

  // Content
  subtitle    String?
  excerpt     String?
  description Json?

  // TeamForge-Specific Fields
  minParticipants  Int?
  maxParticipants  Int?
  idealGroupSize   Int?
  objectives       Json? // Array of ObjectiveType
  learningOutcomes Json? // Array of strings
  physicalDemand   String? // PhysicalLevel
  indoorOutdoor    String? // IndoorOutdoor
  duration         Int // Duration in minutes

  // Materials & Setup
  materialsNeeded  Json? // Array of materials
  setupTime        Int? // Setup time in minutes
  facilitatorGuide Json? // Facilitator instructions
  difficultyLevel  String? // easy | medium | hard | adaptive

  // Scalability
  scalable   Boolean @default(true)
  canCombine Boolean @default(true) // Can be combined with other activities

  // Pricing
  price Int?

  // Media
  featuredImageUrl  String?
  featuredImageAlt  String?
  galleryImages     Json?
  videoUrl          String?
  instructionPdfUrl String?

  // SEO
  seo Json?

  // Relations
  programLinks ProgramActivity[]
  orderItems   OrderItem[]

  @@index([status])
  @@index([slug])
  @@map("activities")
}

// Join table for Programs and Activities (many-to-many)
model ProgramActivity {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  programId  String
  program    Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  order    Int     @default(0) // Order in program
  duration Int? // Override duration for this program
  notes    String? // Program-specific notes

  @@unique([programId, activityId])
  @@index([programId])
  @@index([activityId])
  @@map("program_activities")
}

// Service → Extra (Facilitation, catering coordination, etc.)
model Extra {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info
  title    String
  slug     String @unique
  category String // facilitation | catering | transport | equipment | other
  status   String @default("active")
  order    Int    @default(100)

  // Content
  excerpt     String?
  description Json?

  // Pricing
  priceFrom Int?
  priceUnit String? // per_session | per_person | per_hour | per_day

  // Media
  featuredImageUrl String?
  featuredImageAlt String?

  // SEO
  seo Json?

  // Relations
  orderItems OrderItem[]

  @@index([status])
  @@index([slug])
  @@map("extras")
}

// Event → Session (Scheduled team building session)
model Session {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  programId String?
  program   Program? @relation(fields: [programId], references: [id])

  // Session Details
  date    DateTime
  endDate DateTime?
  venue   Json // { name, city, address, indoorOutdoor }

  // Team Information
  teamSize     Int?
  teamName     String?
  companyName  String?
  industryType String? // IndustryType

  // Objectives for this session
  objectives       Json? // Array of ObjectiveType
  customObjectives String? // Free-text custom objectives

  // Status
  status   String  @default("confirmed") // confirmed | tentative | completed | cancelled
  isPublic Boolean @default(false) // Usually private for corporate

  // Debrief & Reporting
  debriefCompleted   Boolean   @default(false)
  debriefReport      Json? // AI-generated debrief
  debriefGeneratedAt DateTime?

  // Additional Info
  notes String?

  // Relations
  orders Order[]

  @@index([date])
  @@index([programId])
  @@index([status])
  @@map("sessions")
}

// ========================================
// SHARED CORE MODELS (Adapted)
// ========================================

model Customer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info
  email     String  @unique
  firstName String
  lastName  String
  phone     String?

  // Organization (Important for team building)
  organization     String?
  organizationType String? // corporation | nonprofit | government | education
  industryType     String? // IndustryType
  teamSize         Int? // Company team size

  // Address
  address Json?

  // Billing Info
  billingInfo Json?

  // CRM
  tags  Json?
  notes String?

  // GDPR
  gdprConsent Json?

  // Analytics
  averagePaymentDays Int?
  paymentReliability String?
  totalInvoiced      Int       @default(0)
  totalPaid          Int       @default(0)
  invoiceCount       Int       @default(0)
  overdueCount       Int       @default(0)
  lastInvoiceDate    DateTime?
  lastPaymentDate    DateTime?

  // Relations
  orders   Order[]
  invoices Invoice[]

  @@index([email])
  @@index([organization])
  @@map("customers")
}

model Order {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info
  orderNumber String    @unique
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  source      String    @default("manual")
  status      String    @default("new")

  // Session Details
  sessionName String?
  dates       Json // Array of dates
  venue       Json // Venue details

  // Team Information
  teamSize         Int?
  teamComposition  Json? // { departments, roles, seniority }
  objectives       Json? // Array of ObjectiveType
  customObjectives String?
  industryType     String?

  // Program Items
  items OrderItem[]

  // Technical Requirements
  technicalRequirements Json?

  // Pricing
  pricing Json?

  // Payment & Invoicing
  paymentMethod  String?
  paymentDueDate DateTime?
  invoiceEmail   String?

  // Logistics
  logistics Json?

  // Contacts
  contacts Json?

  // Documents
  documents Json?

  // Linked Session
  linkedSessionId String?
  linkedSession   Session? @relation(fields: [linkedSessionId], references: [id])

  // Communication
  internalNotes String?

  // Relations
  invoices Invoice[]

  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Item can be Program, Activity, or Extra
  programId  String?
  program    Program?  @relation(fields: [programId], references: [id])
  activityId String?
  activity   Activity? @relation(fields: [activityId], references: [id])
  extraId    String?
  extra      Extra?    @relation(fields: [extraId], references: [id])

  // Schedule
  date      String
  startTime String?
  endTime   String?

  // Pricing
  price Int     @default(0)
  notes String?

  @@index([orderId])
  @@index([programId])
  @@index([activityId])
  @@index([extraId])
  @@map("order_items")
}

model Invoice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Document Identification
  invoiceNumber String @unique
  status        String @default("draft")

  // Relationships
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  orderId    String?
  order      Order?   @relation(fields: [orderId], references: [id])

  // Dates
  issueDate DateTime  @default(now())
  dueDate   DateTime
  paidDate  DateTime?

  // Line Items
  items Json

  // Totals (in hellers)
  subtotal    Int
  vatRate     Int? @default(0)
  vatAmount   Int? @default(0)
  totalAmount Int

  // Payment Tracking
  paidAmount     Int     @default(0)
  paymentMethod  String?
  bankAccount    String?
  variableSymbol String?

  // Currency
  currency String @default("CZK")

  // PDF
  pdfUrl         String?
  pdfGeneratedAt DateTime?

  // Custom Texts
  textBeforeItems String?
  textAfterItems  String?
  notes           String?

  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([invoiceNumber])
  @@map("invoices")
}

// ========================================
// AUTHENTICATION (NextAuth)
// ========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String    @default("admin")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions UserSession[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model UserSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ========================================
// SETTINGS
// ========================================

model Settings {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Site Info
  siteTitle       String
  siteDescription String?

  // Contact
  contactEmail String?
  contactPhone String?
  address      Json?

  // Social Media
  socialLinks Json?

  // SEO
  defaultSeo Json?

  // Company Info
  companyIco         String?
  companyDic         String?
  companyBankAccount String?

  @@map("settings")
}

// ========================================
// AI METADATA (for tracking AI usage)
// ========================================

model AIUsage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Context
  feature   String // team_dynamics | objective_matcher | difficulty_calibrator | debrief_generator
  sessionId String? // Link to Session if applicable
  orderId   String? // Link to Order if applicable

  // Usage Metrics
  model            String // gpt-4o-mini | gpt-4o
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  latencyMs        Int?

  // Cost tracking (optional)
  estimatedCost Float?

  @@index([feature])
  @@index([createdAt])
  @@map("ai_usage")
}
