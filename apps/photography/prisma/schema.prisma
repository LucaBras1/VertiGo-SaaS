// ShootFlow - Photography Management Platform
// Database Schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CORE MODELS
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      String   @default("free") // free, basic, pro, enterprise
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  settings  Json?    // Business settings (website, phone, address, etc.)

  users               User[]
  packages            Package[]
  shoots              Shoot[]
  shotLists           ShotList[]
  galleries           Gallery[]
  clients             Client[]
  invoices            Invoice[]
  contracts           Contract[]
  contractTemplates   ContractTemplate[]
  payments            Payment[]
  calendarIntegration CalendarIntegration?
  calendarEventSyncs  CalendarEventSync[]
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String
  role          String    @default("photographer") // photographer, admin
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  settings      Json?     // User settings (notifications, preferences, etc.)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId])
}

model Client {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name      String
  email     String
  phone     String?
  address   String?

  // Client type
  type      String   @default("individual") // individual, couple, business
  tags      String[]

  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  packages  Package[]
  invoices  Invoice[]
  contracts Contract[]

  @@index([tenantId])
  @@index([email])
}

// ============================================
// PHOTOGRAPHY MODELS
// ============================================

model Package {
  id        String        @id @default(cuid())
  tenantId  String
  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  clientId  String
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  title     String
  status    PackageStatus @default(INQUIRY)

  // Event details
  eventType String?       // wedding, portrait, corporate, family, product, newborn, maternity
  eventDate DateTime?

  // Photography-specific
  shotCount        Int?      // Estimated final delivered photos
  deliveryDays     Int?      // Days until delivery after shoot
  galleryUrl       String?   // Client gallery link
  editingHours     Float?    // Estimated edit time
  styleTags        String[]  // moody, bright, documentary, artistic
  equipment        String[]  // Cameras, lenses used
  secondShooter    Boolean   @default(false)
  rawFilesIncluded Boolean   @default(false)

  // Timeline
  timeline         Json?     // Shoot day timeline

  // Pricing
  basePrice     Int?
  travelCosts   Int?
  totalPrice    Int?

  // Payment tracking
  depositAmount     Int?
  depositPaidAt     DateTime?
  depositSessionId  String?
  balancePaidAt     DateTime?
  balanceSessionId  String?
  paymentStatus     PaymentStatus @default(PENDING)

  // Metadata
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  shoots        Shoot[]
  addons        PackageAddon[]
  invoices      Invoice[]
  shotLists     ShotList[]
  contracts     Contract[]
  payments      Payment[]

  @@index([tenantId])
  @@index([clientId])
  @@index([status])
  @@index([eventDate])
}

enum PackageStatus {
  INQUIRY
  QUOTE_SENT
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  DEPOSIT_PAID
  PAID
  REFUNDED
  FAILED
}

model PackageAddon {
  id          String   @id @default(cuid())
  packageId   String
  package     Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)

  name        String   // "Photo Album", "Prints", "Drone Coverage", "Rush Delivery"
  description String?
  price       Int
  quantity    Int      @default(1)

  createdAt   DateTime @default(now())

  @@index([packageId])
}

model Shoot {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  packageId   String
  package     Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)

  date        DateTime
  startTime   String
  endTime     String

  // Photography-specific
  shotListId  String?  @unique
  shotList    ShotList? @relation(fields: [shotListId], references: [id])

  timeline        Json?      // Day timeline with key moments
  locations       Json[]     // Multiple locations with addresses
  sunsetTime      DateTime?  // For golden hour planning
  weatherForecast Json?      // Weather data for planning

  // Venue details
  venueType       String?    // indoor, outdoor, mixed
  venueName       String?
  venueAddress    String?
  lightingNotes   String?

  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  galleries         Gallery[]
  calendarEventSync CalendarEventSync?

  @@index([tenantId])
  @@index([packageId])
  @@index([date])
}

// ============================================
// SHOT LIST MODELS
// ============================================

model ShotList {
  id             String         @id @default(cuid())
  tenantId       String
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  packageId      String?
  package        Package?       @relation(fields: [packageId], references: [id], onDelete: SetNull)

  name           String
  status         ShotListStatus @default(DRAFT)
  eventType      String
  aiGenerated    Boolean        @default(false)

  // Organized shot list
  sections       Json           // Array of categories with shots
  totalShots     Int
  mustHaveCount  Int

  // Metadata
  estimatedTime  Int?           // Minutes
  equipmentList  Json?
  lightingPlan   Json?
  backupPlans    Json?

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  shoot          Shoot?

  @@index([tenantId])
  @@index([packageId])
  @@index([status])
}

enum ShotListStatus {
  DRAFT
  FINALIZED
  COMPLETED
}

// ============================================
// GALLERY MODELS
// ============================================

model Gallery {
  id             String        @id @default(cuid())
  tenantId       String
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  shootId        String
  shoot          Shoot         @relation(fields: [shootId], references: [id], onDelete: Cascade)

  name           String
  status         GalleryStatus @default(PROCESSING)

  // AI Curation
  totalPhotos    Int           @default(0)
  selectedPhotos Int           @default(0)
  aiCurated      Boolean       @default(false)
  curationData   Json?         // AI analysis results

  // Client access
  publicUrl      String?       @unique
  password       String?
  expiresAt      DateTime?
  downloadEnabled Boolean      @default(true)

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  photos         GalleryPhoto[]

  @@index([tenantId])
  @@index([shootId])
  @@index([publicUrl])
}

enum GalleryStatus {
  PROCESSING
  READY
  DELIVERED
}

model GalleryPhoto {
  id             String    @id @default(cuid())
  galleryId      String
  gallery        Gallery   @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  filename       String
  url            String
  thumbnailUrl   String?
  publicId       String?   // Cloudinary public ID for deletion
  width          Int?
  height         Int?
  size           Int?      // File size in bytes
  mimeType       String?

  // AI Analysis
  qualityScore   Float?         // 0-100
  category       String?        // ceremony, portraits, reception, etc.
  isHighlight    Boolean        @default(false)
  aiReasoning    String?
  technicalQuality Json?        // sharpness, exposure, composition, color
  emotionalImpact Float?        // 0-10

  // Metadata
  takenAt        DateTime?
  camera         String?
  lens           String?
  settings       Json?          // aperture, shutter, ISO

  // Status
  selected       Boolean        @default(true)
  rejected       Boolean        @default(false)
  rejectionReason String?

  createdAt      DateTime       @default(now())

  @@index([galleryId])
  @@index([selected])
  @@index([isHighlight])
}

// ============================================
// INVOICING
// ============================================

model Invoice {
  id          String        @id @default(cuid())
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  clientId    String
  client      Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  packageId   String?
  package     Package?      @relation(fields: [packageId], references: [id], onDelete: SetNull)

  invoiceNumber String      @unique
  status      InvoiceStatus @default(DRAFT)

  items       Json          // Line items
  subtotal    Int
  tax         Int           @default(0)
  total       Int

  dueDate     DateTime?
  paidAt      DateTime?

  notes       String?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  payments    Payment[]

  @@index([tenantId])
  @@index([clientId])
  @@index([packageId])
  @@index([status])
  @@index([invoiceNumber])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

// ============================================
// AUTH MODELS
// ============================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// ============================================
// CONTRACT MODELS
// ============================================

model Contract {
  id         String         @id @default(cuid())
  tenantId   String
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  packageId  String?
  package    Package?       @relation(fields: [packageId], references: [id], onDelete: SetNull)

  clientId   String?
  client     Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)

  templateId String?
  template   ContractTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  title      String
  status     ContractStatus @default(DRAFT)

  // Content
  content    String         @db.Text
  clauses    Json?          // Additional clauses

  // Signing
  signToken     String?     @unique  // Public signing token
  signedAt      DateTime?
  signedByName  String?
  signedByEmail String?
  signatureData String?     @db.Text  // Base64 signature image
  signatureType String?     // 'draw' | 'type' | 'checkbox'
  ipAddress     String?

  // PDF
  pdfUrl     String?

  // Expiry
  expiresAt  DateTime?

  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([tenantId])
  @@index([packageId])
  @@index([clientId])
  @@index([status])
  @@index([signToken])
}

enum ContractStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  CANCELLED
  EXPIRED
}

model ContractTemplate {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name       String   // "Wedding Contract", "Portrait Contract"
  eventType  String?  // wedding, portrait, corporate
  content    String   @db.Text
  clauses    Json?    // Default clauses
  isDefault  Boolean  @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  contracts  Contract[]

  @@index([tenantId])
  @@index([eventType])
}

// ============================================
// PAYMENT MODELS
// ============================================

model Payment {
  id              String        @id @default(cuid())
  tenantId        String
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  packageId       String?
  package         Package?      @relation(fields: [packageId], references: [id], onDelete: SetNull)

  invoiceId       String?
  invoice         Invoice?      @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  // Stripe data
  stripeSessionId   String?     @unique
  stripePaymentId   String?
  stripeCustomerId  String?

  // Payment details
  amount          Int           // Amount in smallest currency unit (cents/hellers)
  currency        String        @default("CZK")
  status          PaymentStatus @default(PENDING)
  type            PaymentType   // DEPOSIT | BALANCE | FULL | INVOICE

  // Timestamps
  paidAt          DateTime?
  refundedAt      DateTime?
  refundAmount    Int?

  // Metadata
  description     String?
  metadata        Json?
  receiptUrl      String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([tenantId])
  @@index([packageId])
  @@index([invoiceId])
  @@index([stripeSessionId])
  @@index([status])
}

enum PaymentType {
  DEPOSIT
  BALANCE
  FULL
  INVOICE
}

// ============================================
// CALENDAR INTEGRATION
// ============================================

model CalendarIntegration {
  id            String   @id @default(cuid())
  tenantId      String   @unique
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider      String   @default("google") // 'google' | 'outlook' | 'apple'

  // OAuth tokens
  accessToken   String   @db.Text
  refreshToken  String   @db.Text
  tokenExpiry   DateTime

  // Settings
  calendarId    String?  // Selected calendar ID
  syncEnabled   Boolean  @default(true)
  syncDirection String   @default("both") // 'both' | 'to_calendar' | 'from_calendar'

  // Status
  lastSyncAt    DateTime?
  syncError     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model CalendarEventSync {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  shootId         String   @unique
  shoot           Shoot    @relation(fields: [shootId], references: [id], onDelete: Cascade)

  // External event data
  googleEventId   String?
  outlookEventId  String?

  // Sync status
  lastSyncedAt    DateTime?
  syncStatus      String   @default("pending") // 'pending' | 'synced' | 'error' | 'deleted'
  syncError       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([googleEventId])
}
