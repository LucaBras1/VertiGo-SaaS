// EventPro Database Schema
// Multi-tenant event management platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// TENANT & USER MODELS
// ============================================================================

model Tenant {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  subscriptionPlan String @default("free") // free, starter, professional, enterprise
  subscriptionStatus String @default("active")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users         User[]
  events        Event[]
  performers    Performer[]
  venues        Venue[]
  clients       Client[]
  bookings      Booking[]

  @@map("tenants")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  passwordHash  String
  role          String   @default("user") // user, admin, super_admin

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  createdEvents Event[]  @relation("EventCreator")

  @@map("users")
}

// ============================================================================
// EVENT MANAGEMENT
// ============================================================================

model Event {
  id            String   @id @default(cuid())
  name          String
  type          String   // corporate, wedding, festival, private_party, gala, concert, product_launch
  status        String   @default("planning") // planning, confirmed, in_progress, completed, cancelled

  date          DateTime
  startTime     String
  endTime       String
  guestCount    Int?

  description   String?  @db.Text
  notes         String?  @db.Text

  // Venue
  venueId       String?
  venue         Venue?   @relation(fields: [venueId], references: [id])
  venueCustom   String?  // If not using saved venue

  // Client
  clientId      String?
  client        Client?  @relation(fields: [clientId], references: [id])

  // Budget
  totalBudget   Decimal? @db.Decimal(10, 2)
  spentAmount   Decimal? @default(0) @db.Decimal(10, 2)

  // Timeline (AI generated)
  timeline      Json?    // Stores Timeline type from timeline-optimizer

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdById   String
  createdBy     User     @relation("EventCreator", fields: [createdById], references: [id])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bookings      Booking[]
  tasks         EventTask[]

  @@index([tenantId, date])
  @@index([status])
  @@map("events")
}

model Venue {
  id            String   @id @default(cuid())
  name          String
  type          String   // indoor, outdoor, mixed

  address       String?
  city          String?
  capacity      Int?

  setupAccessTime String? // When can vendors start setup
  curfew        String?   // When must event end
  restrictions  String[]  // Array of restrictions

  contactName   String?
  contactEmail  String?
  contactPhone  String?

  notes         String?  @db.Text

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  events        Event[]

  @@index([tenantId])
  @@map("venues")
}

// ============================================================================
// PERFORMER MANAGEMENT
// ============================================================================

model Performer {
  id            String   @id @default(cuid())
  name          String
  stageName     String?
  type          String   // fire, magic, circus, music, dance, comedy, interactive

  bio           String?  @db.Text
  specialties   String[] // Array of specialties

  // Logistics
  setupTime     Int      @default(30)  // minutes
  performanceTime Int    @default(30)  // typical duration
  breakdownTime Int      @default(15)  // minutes

  // Requirements
  requirements  Json?    // Stores technical requirements

  // Contact
  email         String?
  phone         String?
  website       String?

  // Pricing
  standardRate  Decimal? @db.Decimal(10, 2)

  // Availability
  availability  Json?    // Calendar of available dates

  // Rating
  rating        Decimal? @db.Decimal(3, 2)
  totalBookings Int      @default(0)

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bookings      Booking[]

  @@index([tenantId, type])
  @@map("performers")
}

// ============================================================================
// BOOKINGS
// ============================================================================

model Booking {
  id            String   @id @default(cuid())

  eventId       String
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  performerId   String
  performer     Performer @relation(fields: [performerId], references: [id])

  status        String   @default("pending") // pending, confirmed, completed, cancelled

  // Schedule
  callTime      String?
  setupStart    String?
  performanceStart String?
  performanceEnd   String?
  loadOut       String?

  // Pricing
  agreedRate    Decimal  @db.Decimal(10, 2)
  deposit       Decimal? @db.Decimal(10, 2)
  paidAmount    Decimal  @default(0) @db.Decimal(10, 2)

  // Contract
  contractSigned Boolean @default(false)
  contractUrl   String?

  notes         String?  @db.Text

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId, eventId])
  @@index([performerId])
  @@map("bookings")
}

// ============================================================================
// CLIENT MANAGEMENT
// ============================================================================

model Client {
  id            String   @id @default(cuid())

  // Contact
  name          String
  email         String
  phone         String?
  company       String?

  // Address
  address       String?
  city          String?

  // Relationship
  clientType    String   @default("individual") // individual, corporate
  tags          String[] // VIP, repeat_client, etc.

  notes         String?  @db.Text

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  events        Event[]

  @@index([tenantId])
  @@index([email])
  @@map("clients")
}

// ============================================================================
// TASK MANAGEMENT
// ============================================================================

model EventTask {
  id            String   @id @default(cuid())

  eventId       String
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  title         String
  description   String?  @db.Text

  status        String   @default("pending") // pending, in_progress, completed
  priority      String   @default("medium")  // low, medium, high, urgent

  dueDate       DateTime?
  completedAt   DateTime?

  assignedTo    String?  // User ID

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([eventId, status])
  @@map("event_tasks")
}
